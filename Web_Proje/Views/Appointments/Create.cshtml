@model Web_Proje.Models.Appointment

@{
    ViewData["Title"] = "Randevu Oluştur";
}

<div class="container mt-4">
    <h2>Yeni Randevu Oluştur</h2>
    <hr />

    <div class="row">
        <div class="col-md-12">
            <form asp-action="Create">
                <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">1. Adım: Seçim Kriterleri</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 form-group">
                                <label class="control-label fw-bold">Spor Salonu</label>
                                <select id="GymId" name="GymId" class="form-control" onchange="filterOptions('gym')">
                                    <option value="">-- Yükleniyor... --</option>
                                </select>
                            </div>

                            <div class="col-md-4 form-group">
                                <label class="control-label fw-bold">Hizmet Türü</label>
                                <select id="ServiceId" name="ServiceId" class="form-control" onchange="filterOptions('service')">
                                    <option value="">-- Yükleniyor... --</option>
                                </select>
                            </div>

                            <div class="col-md-4 form-group">
                                <label class="control-label fw-bold">Eğitmen</label>
                                <select id="TrainerId" name="TrainerId" class="form-control" onchange="filterOptions('trainer')">
                                    <option value="">-- Yükleniyor... --</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4" id="dateSection" style="display:none;">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">2. Adım: Tarih ve Saat</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 form-group">
                                <label asp-for="AppointmentDate" class="control-label">Tarih Seçiniz</label>
                                <input type="date"
                                       id="selectedDate"
                                       class="form-control"
                                       min="@DateTime.Now.ToString("yyyy-MM-dd")"
                                       onchange="getSlots()" />
                                <span asp-validation-for="AppointmentDate" class="text-danger"></span>
                            </div>

                            <div class="col-md-12 mt-3">
                                <label>Müsait Saatler:</label>
                                <div id="slotsContainer" class="d-flex flex-wrap gap-2">
                                    <span class="text-muted small">Lütfen önce tarih seçiniz.</span>
                                </div>
                                <input type="hidden" asp-for="AppointmentDate" id="finalDateTime" />
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group mt-3">
                    <input type="submit" value="Randevu Oluştur" class="btn btn-success btn-lg" id="submitBtn" disabled />
                    <a asp-action="Index" class="btn btn-secondary btn-lg">Listeye Dön</a>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        const masterData = @Html.Raw(ViewBag.MasterData ?? "{}");

        $(document).ready(function () {
            // Veri boşsa uyarı
            if (!masterData.Trainers || !masterData.Gyms) {
                console.error("MasterData eksik! Controller tarafını kontrol et.");
                return;
            }
            // Sayfa açılışında tüm listeleri doldur
            initDropdowns();
        });

        // --- İLK YÜKLEME ---
        function initDropdowns() {
            populateSelect("GymId", masterData.Gyms);
            populateSelect("ServiceId", masterData.Services);
            populateSelect("TrainerId", masterData.Trainers);
        }

        function populateSelect(elementId, dataList, selectedValue = null) {
            const select = document.getElementById(elementId);
            const currentVal = selectedValue || select.value;

            select.innerHTML = '<option value="">-- Seçiniz --</option>';

            dataList.forEach(item => {
                const option = document.createElement("option");
                option.value = item.Id;
                option.text = (item.Name || item.name) + (item.Price || item.price ? ` (${item.Price||item.price} TL)` : '');
                select.appendChild(option);
            });

            
            if (currentVal && dataList.some(x => (x.Id || x.id) == currentVal)) {
                select.value = currentVal;
            } else {
                select.value = "";
            }

            // Tarih kısmını kontrol et
            checkDateSectionVisibility();
        }

       
        function filterOptions(source) {
            const selectedGymId = document.getElementById("GymId").value;
            const selectedServiceId = document.getElementById("ServiceId").value;
            const selectedTrainerId = document.getElementById("TrainerId").value;

            
            let filteredTrainers = masterData.Trainers.filter(t => {
                const gymMatch = !selectedGymId || t.GymId == selectedGymId;
                
                const serviceMatch = !selectedServiceId || t.ServiceIds.includes(parseInt(selectedServiceId));
                return gymMatch && serviceMatch;
            });

            
            let filteredGyms = masterData.Gyms.filter(g => {
                if (!selectedTrainerId) return true;
                const trainer = masterData.Trainers.find(t => t.Id == selectedTrainerId);
                return trainer && trainer.GymId == g.Id;
            });

            
            let filteredServices = masterData.Services.filter(s => {
                if (!selectedTrainerId) return true;
                const trainer = masterData.Trainers.find(t => t.Id == selectedTrainerId);
                return trainer && trainer.ServiceIds.includes(s.Id);
            });

            
            if (source !== 'gym') populateSelect("GymId", filteredGyms, selectedGymId);
            if (source !== 'service') populateSelect("ServiceId", filteredServices, selectedServiceId);
            if (source !== 'trainer') populateSelect("TrainerId", filteredTrainers, selectedTrainerId);

            // Slotları temizle çünkü kriterler değişti
            document.getElementById("slotsContainer").innerHTML = '<span class="text-warning">Kriterler değişti, lütfen tekrar tarih seçiniz.</span>';
            document.getElementById("submitBtn").disabled = true;
        }

        function checkDateSectionVisibility() {
            const trainerId = document.getElementById("TrainerId").value;
            const serviceId = document.getElementById("ServiceId").value;
            const dateSection = document.getElementById("dateSection");

            
            if(trainerId && serviceId) {
                dateSection.style.display = "block";
            } else {
                dateSection.style.display = "none";
            }
        }

       
        //api/TrainersApi/{id}/slots metodunu kullanır
        async function getSlots() {
            const trainerId = document.getElementById("TrainerId").value;
            const serviceId = document.getElementById("ServiceId").value;
            const dateVal = document.getElementById("selectedDate").value;
            const container = document.getElementById("slotsContainer");

            if (!trainerId || !serviceId || !dateVal) return;

            container.innerHTML = 'Yukleniyor...';

            try {
                // URL: /api/TrainersApi/5/slots?date=2023-10-29&serviceId=2
                const response = await fetch(`/api/TrainersApi/${trainerId}/slots?date=${dateVal}&serviceId=${serviceId}`);
                if (!response.ok) throw new Error("Slotlar alınamadı");

                const slots = await response.json();
                container.innerHTML = "";

                if (slots.length === 0) {
                    container.innerHTML = '<span class="text-danger">Uygun saat bulunamadı.</span>';
                    return;
                }

                slots.forEach(slot => {
                    // Buton oluştur
                    const btn = document.createElement("button");
                    btn.type = "button";
                    btn.className = slot.isAvailable ? "btn btn-outline-success m-1" : "btn btn-outline-secondary m-1 disabled";
                    btn.innerText = slot.time;
                    btn.disabled = !slot.isAvailable;

                    if (slot.isAvailable) {
                        btn.onclick = function() {
                            // Seçimi işaretle
                            document.querySelectorAll("#slotsContainer button").forEach(b => b.classList.remove("active"));
                            btn.classList.add("active");

                            // Hidden input'a tam DateTime formatında yaz
                            const finalDate = `${dateVal}T${slot.time}:00`;
                            document.getElementById("finalDateTime").value = finalDate;

                            // Kaydet butonunu aç
                            document.getElementById("submitBtn").disabled = false;
                        };
                    }
                    container.appendChild(btn);
                });

            } catch (err) {
                console.error(err);
                container.innerHTML = '<span class="text-danger">Hata oluştu.</span>';
            }
        }
    </script>
}